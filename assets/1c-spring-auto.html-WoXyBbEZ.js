import{_ as i}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as c,o as t,c as d,b as n,e,d as a,f as s}from"./app-mN42Vc4a.js";const l={},p=s('<h1 id="_1c-自动配置机制" tabindex="-1"><a class="header-anchor" href="#_1c-自动配置机制"><span>1C.自动配置机制</span></a></h1><p>利用SpringBoot的特性，完成自动配置。</p><h2 id="_1c-1-自动规则和命名" tabindex="-1"><a class="header-anchor" href="#_1c-1-自动规则和命名"><span>1C.1.自动规则和命名</span></a></h2><p>有特殊功能的spring命名，主要集中在以下（后续目录结构有详解）</p><ul><li><code>/wings-conf/</code> 自动加载，分割的配置文件</li><li><code>/wings-i18n/</code> 自动加载，分割的多国语的信息文件</li><li><code>**/spring/boot/</code> 手动加载，Boot有关的配置，如<code>spring.factories</code></li><li><code>**/spring/bean/</code> 自动加载，比如@ComponentScan指定</li><li><code>**/spring/conf/</code> Configurer或AutoConfiguration</li><li><code>**/spring/prop/</code> properties的映射</li><li><code>**/spring/help/</code> 配置助手</li><li><code>*Configuration.java</code> 条件加载，配置项以<code>wings.enabled.</code>为前缀</li></ul><p>使用<code>idea</code>开发时，会有黄色警告或提示，不影响运行，但看着碍眼</p><ul><li>提示Application context not configured for this file， 在<code>Project Structure</code>/<code>Facets</code>/<code>Spring</code>手动添加<code>boot/WingsAutoConfiguration</code>一个即可。</li><li>提示 annotation processing的设置，在<code>Settings</code>/<code>Annotation Processors</code>/<code>Enable annotation processing</code></li><li>注意：在<code>@Configuration</code>中的内部类，<code>static class</code>是按独立类处理的，不受外层约束。</li></ul><p>在wings工程中，会存在<code>wings-enabled.properties</code>配置，作为功能开关。 可以设置<code>wings.enabled.silencer.verbose=true</code> 通过日志的INFO查看。</p><h2 id="_1c-2-属性bind和meta提示" tabindex="-1"><a class="header-anchor" href="#_1c-2-属性bind和meta提示"><span>1C.2.属性bind和meta提示</span></a></h2><p>属性类统一用<code>*Prop.java</code>和<code>@Data</code>，经过配置后，可以自动提示。</p><ul><li>手动添加 additional-spring-configuration-metadata.json</li><li>自动生成 spring-configuration-metadata.json</li></ul><p>参考资料</p>',12),r={href:"https://docs.spring.io/spring-boot/docs/3.0.3/reference/htmlsingle/#appendix.configuration-metadata",target:"_blank",rel:"noopener noreferrer"},u={href:"https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-Configuration-Binding",target:"_blank",rel:"noopener noreferrer"},g={href:"https://github.com/spring-projects/spring-boot/wiki/IDE-binding-features#simple-pojo",target:"_blank",rel:"noopener noreferrer"},m=s(`<h2 id="_1c-3-按条件配置事项" tabindex="-1"><a class="header-anchor" href="#_1c-3-按条件配置事项"><span>1C.3.按条件配置事项</span></a></h2><ul><li>配置类为<code>*Configuration.java</code>在<code>/spring/bean/</code>中</li><li>属性类为<code>*Prop.java</code>在<code>/spring/prop/</code>中</li><li>嵌套配置不继承<code>@Conditional</code><ul><li>要合并为<code>@ConditionalOnExpression</code></li><li>或自定义一个<code>@Conditional</code></li></ul></li><li>多个<code>@Conditional</code>为<code>and</code>逻辑</li><li>多个<code>Condition</code>为<code>and</code>逻辑</li></ul><p>以下为<code>Conditional</code> javadoc</p><blockquote><p>The <code>@Conditional</code> annotation may be used in any of the following ways:</p><ul><li>as a type-level annotation on any class directly or indirectly annotated with <code>@Component</code>, including <code>@Configuration</code> classes</li><li>as a meta-annotation, for the purpose of composing custom stereotype annotations</li><li>as a method-level annotation on any <code>@Bean</code> method</li></ul><p>If a <code>@Configuration</code> class is marked with <code>@Conditional</code>,all of the <code>@Bean</code> methods, <code>@Import</code> annotations, and <code>@ComponentScan</code> annotations associated with that class will be subject to the conditions.</p><p>NOTE: Inheritance of <code>@Conditional</code> annotations is not supported; any conditions from superclasses or from overridden methods will not be considered.</p></blockquote><h2 id="_1c-4-conditionalonclass无效" tabindex="-1"><a class="header-anchor" href="#_1c-4-conditionalonclass无效"><span>1C.4.ConditionalOnClass无效</span></a></h2><p>如下代码，ConditionalOnClass置于同类型的Bean声明上，会报错 NoClassDefFoundError</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">SomeService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">SomeService</span> <span class="token function">someService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SomeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要改为如下这种，内类控制的Configuration</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">SomeService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SomeServiceConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SomeService</span> <span class="token function">someService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SomeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,9),k={href:"https://docs.spring.io/spring-boot/docs/3.0.3/reference/htmlsingle/#features.developing-auto-configuration",target:"_blank",rel:"noopener noreferrer"},v=s(`<h2 id="_1c-5-禁用任意-component" tabindex="-1"><a class="header-anchor" href="#_1c-5-禁用任意-component"><span>1C.5.禁用任意 <code>@Component</code></span></a></h2><p>在spring的<code>@Conditional</code>自动配置体系中，<code>On*Bean</code> 依赖于Bean的注册顺序，很难发现问题。 所以在wings中，把问题提前到启动阶段，尽早发现Bean冲突，可通过设置属性文件关闭不需要功能。</p><p>在<code>@Configuration</code>, <code>@Bean</code>和任何<code>@Component</code>上，使用以下<code>@ConditionalWingsEnabled</code> 并指定<code>限定key</code>，可以禁用任意Component和Bean，</p><p><code>限定key</code> = <code>前缀.</code> + <code>全类名</code> + <code>.方法名</code>? = <code>true|false</code></p><ul><li>前缀 - 默认 wings.enabled</li><li>全类名 - 比如 pro.fessional.wings.silencer.spring.boot.WingsEnabledCondition</li><li>方法名 - 比如 crc8Long</li></ul><p><code>@*Configuration</code> 的命名规则如下，</p><ul><li><code>*AutoConfiguration</code> - <code>@AutoConfiguration</code> <code>@Import</code> <code>@Configuration</code></li><li><code>*Configuration</code> - 顶级 <code>@Configuration</code> 及其 <code>@Bean</code></li><li><code>*Event</code> - 内类 <code>@Configuration</code> 及其 <code>@EventListener</code></li><li><code>*Wired</code> - 内类 <code>@Configuration</code> 及其 <code>@Autowired</code></li><li><code>*Bean</code> - 内类 <code>@Configuration</code> 及其包装的单一 <code>@Bean *</code></li><li><code>*Scan</code> - 内类 <code>@Configuration</code> 用来 <code>@ComponentScan</code></li></ul><p><code>@ConditionalWingsEnabled</code> 具有以下增强功能</p><ul><li>abs - <code>绝对key</code>，无视前缀，优先级低于<code>限定key</code></li><li>key - <code>相对key</code>，使用前缀，优先级低于<code>绝对key</code></li><li>value - 默认值，最低优先级，key不存在时使用</li><li>and, not - <code>this &amp;&amp; and1 &amp;&amp; and2 &amp;&amp; !not1 &amp;&amp; !not2</code></li></ul><p>其中，<code>限定key</code>相当于id，全局唯一，具有最高优先级，<code>绝对key</code>和<code>相对key</code>相当于别名， 不需要唯一，可以多处共用。这三种key的优先级从高到低如下，</p><ul><li>限定key = <code>prefix</code> + <code>ClassName</code> + <code>methodName</code>?</li><li>绝对key = <code>abs()</code></li><li>相对key = <code>prefix</code> + <code>key()</code></li><li>默认值 = <code>value()</code></li></ul><p>除了注解的精确控制，也可以通过以下属性，对<code>限定key</code>实现<code>ant-matcher</code>规则的控制。</p><ul><li>wings.silencer.conditional.error</li><li>wings.silencer.conditional.prefix</li><li>wings.silencer.conditional.enable</li></ul><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment">## ... 为包名缩写</span>

<span class="token comment">## @ConditionalWingsEnabled(prefix = &quot;catty.enabled&quot;)</span>
<span class="token comment">## 禁用 @Bean catBean 于 WingsEnabledCatConfiguration</span>
<span class="token key attr-name">catty.enabled.pro...WingsEnabledCatConfiguration.catBean</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token comment">## 禁用 InnerCatConfiguration 及其 Bean</span>
<span class="token key attr-name">catty.enabled.pro...WingsEnabledCatConfiguration$InnerCatConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>

<span class="token comment">## @Conditional(WingsEnabledCondition.class) or @ConditionalWingsEnabled</span>
<span class="token comment">## 禁用 @Bean dogBean 于 WingsEnabledDogConfiguration</span>
<span class="token key attr-name">wings.enabled.pro...WingsEnabledDogConfiguration.dogBean</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token comment">## 禁用 InnerDogConfiguration 及其 Bean</span>
<span class="token key attr-name">wings.enabled.pro...WingsEnabledDogConfiguration$InnerDogConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14);function b(f,h){const o=c("ExternalLinkIcon");return t(),d("div",null,[p,n("ul",null,[n("li",null,[n("a",r,[e("https://docs.spring.io/spring-boot/docs/3.0.3/reference/htmlsingle/#appendix.configuration-metadata"),a(o)])]),n("li",null,[n("a",u,[e("https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-Configuration-Binding"),a(o)])]),n("li",null,[n("a",g,[e("https://github.com/spring-projects/spring-boot/wiki/IDE-binding-features#simple-pojo"),a(o)])])]),m,n("p",null,[e("参考"),n("a",k,[e("Creating Your Own Auto-configuration"),a(o)])]),v])}const _=i(l,[["render",b],["__file","1c-spring-auto.html.vue"]]);export{_ as default};
