import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as i,c as l,b as e,e as n,d as a,f as t}from"./app-D49wbIsR.js";const c={},p=e("h1",{id:"_9c2-记录和重放请求",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#_9c2-记录和重放请求"},[e("span",null,"9C2.记录和重放请求")])],-1),d=e("p",null,"在正式环境下，需求对某些http请求进行记录和重放。 简单易行的策略有，Nginx的mirror复制到GoReplay或wiremock。",-1),u=e("p",null,"参考资料如下，本手册以mirror微信请求到mocklab云服务和Gor本地服务为例",-1),m={href:"https://nginx.org/en/docs/http/ngx_http_mirror_module.html",target:"_blank",rel:"noopener noreferrer"},k={href:"https://wiremock.org/",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/buger/goreplay/wiki",target:"_blank",rel:"noopener noreferrer"},h=e("h2",{id:"_9c2-1-mocklab服务",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#_9c2-1-mocklab服务"},[e("span",null,"9C2.1.mocklab服务")])],-1),_=e("p",null,"使用github申请free账号，获得Mock APIs的URL和Token，如 Settings/Usage examples中的curl例子中有相应字段，如下特征，",-1),g={href:"https://xxxx.mocklab.io/",target:"_blank",rel:"noopener noreferrer"},b=e("li",null,"Token 14ef56fxxxx24fba5",-1),x=t(`<p>最后，可以在 Request Log 中获得所有请求，并Convert to stub以便测试使用。</p><h2 id="_9c2-2-gor本地服务" tabindex="-1"><a class="header-anchor" href="#_9c2-2-gor本地服务"><span>9C2.2.gor本地服务</span></a></h2><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">wget</span> https://github.com/buger/goreplay/releases/download/1.3.3/gor_1.3.3_x64.tar.gz
<span class="token function">tar</span> <span class="token parameter variable">-xzf</span> gor_1.3.3_x64.tar.gz
<span class="token comment"># 开启并监听 18081，若是attach到其他服务端口，则不需要http-pprof</span>
<span class="token function">tee</span> gor.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
gor_file=weixin-%Y%m%d.gor
cur_file=$(date +$gor_file)
test -f &quot;$cur_file&quot; &amp;&amp; mv $cur_file $cur_file.$(date +%H%M%S)
./gor --http-pprof :18081 \\
--input-raw :18081 \\
--output-file $gor_file \\
--output-file-append
EOF</span>
<span class="token function">chmod</span> +x gor.sh
<span class="token function">sudo</span> <span class="token function">nohup</span> ./gor.sh <span class="token operator">&amp;</span>
<span class="token comment"># test</span>
<span class="token function">curl</span> http://127.0.0.1:18081/debug/pprof/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),f={href:"https://github.com/buger/goreplay/blob/master/output_file.go",target:"_blank",rel:"noopener noreferrer"},y=t(`<ul><li>output-file-append无效，重启gor时会覆盖gor文件，需要注意备份</li><li>output-file 不会自动flush，只能buff满或关闭gor</li><li>若需要实时观测，建议使用 output-stdout</li></ul><h2 id="_9c2-3-nginx的mirror" tabindex="-1"><a class="header-anchor" href="#_9c2-3-nginx的mirror"><span>9C2.3.nginx的mirror</span></a></h2><blockquote><p>The ngx_http_mirror_module module (1.13.4) implements mirroring of an original request by creating background mirror subrequests. Responses to mirror subrequests are ignored.</p></blockquote><div class="language-nginx line-numbers-mode" data-ext="nginx" data-title="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /weixin/geteway.api</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">mirror</span> /__mirror_mock</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">mirror</span> /__mirror_gor</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://xxxx</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> = /__mirror_mock</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">resolver</span> 8.8.8.8</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> https://xxx.mocklab.io<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Authorization <span class="token string">&quot;Token 14exxxxxxxba5&quot;</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> = /__mirror_gor</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:18081<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9c2-4-使用建议" tabindex="-1"><a class="header-anchor" href="#_9c2-4-使用建议"><span>9C2.4.使用建议</span></a></h2><p>gor和mocklab设置其一即可，根据情况取舍，dev环境建议mocklab，便于生成test。</p><p>若mirror没有转发，可观测nginx error日志，上例中的<code>resolver 8.8.8.8</code>解决以下问题，</p><p>no resolver defined to resolve xxx.mocklab.io, request: &quot;POST ...&quot;</p>`,8);function w(q,C){const s=o("ExternalLinkIcon");return i(),l("div",null,[p,d,u,e("ul",null,[e("li",null,[e("a",m,[n("Nginx/mirror"),a(s)])]),e("li",null,[e("a",k,[n("wiremock/mocklab"),a(s)])]),e("li",null,[e("a",v,[n("GoReplay/Gor"),a(s)])])]),h,_,e("ul",null,[e("li",null,[e("a",g,[n("https://xxxx.mocklab.io/"),a(s)])]),b]),x,e("p",null,[n("注意，gor 2.0目前还在rc阶段，1.3实测中存在一些问题，比如保存文件时 "),e("a",f,[n("https://github.com/buger/goreplay/blob/master/output_file.go"),a(s)])]),y])}const N=r(c,[["render",w],["__file","9c2.request-record-replay.html.vue"]]),T=JSON.parse('{"path":"/zh/9-example/9c.server-manual/9c2.request-record-replay.html","title":"9C2.记录和重放请求","lang":"zh-CN","frontmatter":{"isOriginal":true,"icon":"launch","category":["实战","copy"],"description":"9C2.记录和重放请求 在正式环境下，需求对某些http请求进行记录和重放。 简单易行的策略有，Nginx的mirror复制到GoReplay或wiremock。 参考资料如下，本手册以mirror微信请求到mocklab云服务和Gor本地服务为例 Nginx/mirror wiremock/mocklab GoReplay/Gor 9C2.1.moc...","GIT_REPO_HEAD":"2024-05-14 c11179d9405d56bdce1d844167180312da5251a8","head":[["link",{"rel":"alternate","hreflang":"en-us","href":"https://wings.fessional.pro/9-example/9c.server-manual/9c2.request-record-replay.html"}],["meta",{"property":"og:url","content":"https://wings.fessional.pro/zh/9-example/9c.server-manual/9c2.request-record-replay.html"}],["meta",{"property":"og:site_name","content":"WingsBoot 纹丝不忒"}],["meta",{"property":"og:title","content":"9C2.记录和重放请求"}],["meta",{"property":"og:description","content":"9C2.记录和重放请求 在正式环境下，需求对某些http请求进行记录和重放。 简单易行的策略有，Nginx的mirror复制到GoReplay或wiremock。 参考资料如下，本手册以mirror微信请求到mocklab云服务和Gor本地服务为例 Nginx/mirror wiremock/mocklab GoReplay/Gor 9C2.1.moc..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:locale:alternate","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2023-06-18T08:37:26.000Z"}],["meta",{"property":"article:author","content":"trydofor"}],["meta",{"property":"article:modified_time","content":"2023-06-18T08:37:26.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"9C2.记录和重放请求\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-06-18T08:37:26.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"trydofor\\",\\"url\\":\\"https://www.trydofor.com\\"}]}"]]},"headers":[{"level":2,"title":"9C2.1.mocklab服务","slug":"_9c2-1-mocklab服务","link":"#_9c2-1-mocklab服务","children":[]},{"level":2,"title":"9C2.2.gor本地服务","slug":"_9c2-2-gor本地服务","link":"#_9c2-2-gor本地服务","children":[]},{"level":2,"title":"9C2.3.nginx的mirror","slug":"_9c2-3-nginx的mirror","link":"#_9c2-3-nginx的mirror","children":[]},{"level":2,"title":"9C2.4.使用建议","slug":"_9c2-4-使用建议","link":"#_9c2-4-使用建议","children":[]}],"git":{"createdTime":1687077446000,"updatedTime":1687077446000,"contributors":[{"name":"trydofor","email":"trydofor@gmail.com","commits":1}]},"readingTime":{"minutes":1.52,"words":456},"filePathRelative":"zh/9-example/9c.server-manual/9c2.request-record-replay.md","localizedDate":"2023年6月18日","autoDesc":true}');export{N as comp,T as data};
