import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r,o as i,c as l,b as e,e as n,d as a,f as o}from"./app-0857a5f3.js";const c={},p=e("h1",{id:"_9c2-request-record-replay",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#_9c2-request-record-replay","aria-hidden":"true"},"#"),n(" 9C2.Request Record/Replay")],-1),d=e("p",null,"In the product environment, there is a need to log and replay certain http requests. Simple and easy way is Nginx's mirror replication to GoReplay or wiremock.",-1),u=e("p",null,"The reference is as follows, this manual uses mirror WeChat requests to mocklab service and Gor local server as an example,",-1),v={href:"https://nginx.org/en/docs/http/ngx_http_mirror_module.html",target:"_blank",rel:"noopener noreferrer"},h={href:"https://wiremock.org/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/buger/goreplay/wiki",target:"_blank",rel:"noopener noreferrer"},k=e("h2",{id:"_9c2-1-mocklab-service",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#_9c2-1-mocklab-service","aria-hidden":"true"},"#"),n(" 9C2.1.Mocklab Service")],-1),_=e("p",null,"Use github to apply for a free account and get the URLs and Tokens of the Mock APIs, such as The curl in Settings/Usage examples has the appropriate fields, with the following features",-1),b={href:"https://xxxx.mocklab.io/",target:"_blank",rel:"noopener noreferrer"},g=e("li",null,"Token 14ef56fxxxx24fba5",-1),f=o(`<p>Finally, you can get all the requests in the Request Log and Convert to stub for testing purposes.</p><h2 id="_9c2-2-gor-local-server" tabindex="-1"><a class="header-anchor" href="#_9c2-2-gor-local-server" aria-hidden="true">#</a> 9C2.2.Gor Local Server</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> https://github.com/buger/goreplay/releases/download/1.3.3/gor_1.3.3_x64.tar.gz
<span class="token function">tar</span> <span class="token parameter variable">-xzf</span> gor_1.3.3_x64.tar.gz
<span class="token comment"># Open and listen on 18081, if attaching to another service port, don&#39;t need http-pprof</span>
<span class="token function">tee</span> gor.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
gor_file=weixin-%Y%m%d.gor
cur_file=$(date +$gor_file)
test -f &quot;$cur_file&quot; &amp;&amp; mv $cur_file $cur_file.$(date +%H%M%S)
./gor --http-pprof :18081 \\
--input-raw :18081 \\
--output-file $gor_file \\
--output-file-append
EOF</span>
<span class="token function">chmod</span> +x gor.sh
<span class="token function">sudo</span> <span class="token function">nohup</span> ./gor.sh <span class="token operator">&amp;</span>
<span class="token comment"># test</span>
<span class="token function">curl</span> http://127.0.0.1:18081/debug/pprof/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),x={href:"https://github.com/buger/goreplay/blob/master/output_file.go",target:"_blank",rel:"noopener noreferrer"},y=o(`<ul><li>output-file-append is invalid, restarting gor will overwrite gor file, should backup if needed</li><li>output-file does not flush automatically, only buff full or close gor</li><li>output-stdout is recommended if you need to watch in real time</li></ul><h2 id="_9c2-3-nginx-mirror" tabindex="-1"><a class="header-anchor" href="#_9c2-3-nginx-mirror" aria-hidden="true">#</a> 9C2.3.Nginx Mirror</h2><blockquote><p>The ngx_http_mirror_module module (1.13.4) implements mirroring of an original request by creating background mirror subrequests. Responses to mirror subrequests are ignored.</p></blockquote><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /weixin/geteway.api</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">mirror</span> /__mirror_mock</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">mirror</span> /__mirror_gor</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://xxxx</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> = /__mirror_mock</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">resolver</span> 8.8.8.8</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> https://xxx.mocklab.io<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Authorization <span class="token string">&quot;Token 14exxxxxxxba5&quot;</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> = /__mirror_gor</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:18081<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9c2-4-usage-suggestion" tabindex="-1"><a class="header-anchor" href="#_9c2-4-usage-suggestion" aria-hidden="true">#</a> 9C2.4.Usage Suggestion</h2><p>One of gor or mocklab is enough, depending on the situation, mocklab is recommended for dev environment, it is easy to generate test.</p><p>If mirror does not forward, you can check the nginx error log, and the <code>resolver 8.8.8.8</code> in the above example solves the following problem.</p><p>no resolver defined to resolve xxx.mocklab.io, request: &quot;POST ...&quot;</p>`,8);function w(q,$){const s=r("ExternalLinkIcon");return i(),l("div",null,[p,d,u,e("ul",null,[e("li",null,[e("a",v,[n("Nginx/mirror"),a(s)])]),e("li",null,[e("a",h,[n("wiremock/mocklab"),a(s)])]),e("li",null,[e("a",m,[n("GoReplay/Gor"),a(s)])])]),k,_,e("ul",null,[e("li",null,[e("a",b,[n("https://xxxx.mocklab.io/"),a(s)])]),g]),f,e("p",null,[n("Note that gor 2.0 is still in the rc stage, and there are some issues in the 1.3 live test, such as when saving files "),e("a",x,[n("https://github.com/buger/goreplay/blob/master/output_file.go"),a(s)])]),y])}const N=t(c,[["render",w],["__file","9c2.request-record-replay.html.vue"]]);export{N as default};
