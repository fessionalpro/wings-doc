import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o,c,b as n,e as s,d as t,f as l}from"./app-cb212eee.js";const u={},i=n("h1",{id:"_9d1-jooq-better-practive",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_9d1-jooq-better-practive","aria-hidden":"true"},"#"),s(" 9D1.Jooq Better Practive")],-1),k=n("p",null,"Wings simplified Jooq with the following conventions and syntax sugar in practice,",-1),d={href:"https://github.com/trydofor/pro.fessional.wings/blob/master/wings/faceless-jooq/src/test/java/pro/fessional/wings/faceless/sample/JooqDslAndDaoSample.java",target:"_blank",rel:"noopener noreferrer"},r={href:"https://github.com/trydofor/pro.fessional.wings/blob/master/wings/faceless-jooq/src/test/java/pro/fessional/wings/faceless/sample/JooqMostSelectSample.java",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/trydofor/pro.fessional.wings/blob/master/wings/faceless-jooq/src/test/java/pro/fessional/wings/faceless/jooq/JooqDeleteListenerTest.java",target:"_blank",rel:"noopener noreferrer"},v=l(`<h2 id="_9d1-1-code-generator" tabindex="-1"><a class="header-anchor" href="#_9d1-1-code-generator" aria-hidden="true">#</a> 9D1.1.Code Generator</h2><p>Recommend using <code>Warlock3JooqGenerator</code>, which further encapsulates <code>WingsCodeGenerator</code>.</p><ul><li>databaseIncludes - specify the table to generate code based on RegExp</li><li>setGlobalSuffix - add suffix to global objects to distinguish different projects from the same package</li><li>forcedStrCodeEnum - bind varchar and enum types</li><li>forcedIntConsEnum - bind int and enum types</li><li>forcedLocale - bind varchar and locale types</li><li>forcedZoneId - bind int and ZoneId types</li><li>forcedZoneStr - bind varchar and ZoneId types</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Warlock3JooqGenerator</span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Warlock3JooqGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
generator<span class="token punctuation">.</span><span class="token function">setTargetDir</span><span class="token punctuation">(</span><span class="token constant">JAVA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
generator<span class="token punctuation">.</span><span class="token function">gen</span><span class="token punctuation">(</span><span class="token constant">JDBC</span><span class="token punctuation">,</span> <span class="token constant">USER</span><span class="token punctuation">,</span> <span class="token constant">PASS</span><span class="token punctuation">,</span>
        <span class="token class-name">Warlock3JooqGenerator</span><span class="token punctuation">.</span><span class="token function">includeWarlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bd <span class="token operator">-&gt;</span> bd<span class="token punctuation">.</span><span class="token function">setGlobalSuffix</span><span class="token punctuation">(</span><span class="token string">&quot;Warlock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The default configuration maps the following types,</p><ul><li>Boolean - <code>TINYINT(\\(1\\))?</code> match all fields</li><li>Integer - <code>TINYINT[2-9()]*</code> match all fields</li><li>Locale - field <code>.*\\.locale</code> match all types</li><li>ZoneId - field <code>*\\.zoneid</code> match <code>INT.*</code> and <code>(VAR)?CHAR.*</code></li></ul><h2 id="_9d1-2-dao-and-dsl" tabindex="-1"><a class="header-anchor" href="#_9d1-2-dao-and-dsl" aria-hidden="true">#</a> 9D1.2.Dao and Dsl</h2><p>Jooq official examples are in style of importing static Table, injected Dsl, but Wings recommend to start from Dao.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Complete Setter injection with lombok</span>
<span class="token annotation punctuation">@Setter</span><span class="token punctuation">(</span>onMethod_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Autowired</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">WinConfRuntimeDao</span> dao<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Check table exists</span>
dao<span class="token punctuation">.</span><span class="token function">notTableExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// obtain Table and Dsl from Dao</span>
<span class="token class-name">WinConfRuntimeTable</span> a <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WinConfRuntimeTable</span> t <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DSLContext</span> dsl <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>There are many methods in WingsJooqDaoAliasImpl and WingsJooqDaoJournalImpl</p><ul><li>batchXX - batch insert, merge, update, etc.</li><li>fetchXX - select data by type or automatically</li><li>countXX - count the number of records</li><li>insertXX - insert related</li><li>updateXX - update related</li><li>deleteXX - logical or physical delete</li></ul><p>Dsl and Dao are equivalent and both are used below the service layer.</p><ul><li>Dao is used for simple operations, Dsl is used for complex ones</li><li>Dao is more like java, Dsl is more like Sql</li><li>Both explicitly table or alias when there are conditions and fields</li><li>Dsl can getSql, also use Any2Dto turn Sql into Dsl</li></ul><h2 id="_9d1-3-accurate-select" tabindex="-1"><a class="header-anchor" href="#_9d1-3-accurate-select" aria-hidden="true">#</a> 9D1.3.Accurate Select</h2><p>Get what you need and receive it with the typesafe pojo or record to ensure strong type.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">WinUserLoginTable</span> t <span class="token operator">=</span> winUserLoginDao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao </span>
dao<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span>
    <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao lambda</span>
dao<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> w
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dsl</span>
winUserLoginDao
    <span class="token punctuation">.</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>AuthType</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginIp</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginDt</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Terminal</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Failed</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginDt</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">toOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> query<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-4-accurate-update" tabindex="-1"><a class="header-anchor" href="#_9d1-4-accurate-update" aria-hidden="true">#</a> 9D1.4.Accurate Update</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">WinUserBasisTable</span> tu <span class="token operator">=</span> winUserBasisDao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao map</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> setter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Nickname</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> commit<span class="token punctuation">.</span><span class="token function">getCommitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
winUserBasisDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tu<span class="token punctuation">,</span> setter<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao pojo</span>
<span class="token class-name">WinUserBasisTable</span> upo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WinUserBasisTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
upo<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
upo<span class="token punctuation">.</span><span class="token function">setCommitId</span><span class="token punctuation">(</span>commit<span class="token punctuation">.</span><span class="token function">getCommitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
winUserBasisDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tu<span class="token punctuation">,</span> upo<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Dsl</span>
winPermEntryDao
    <span class="token punctuation">.</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tu<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> commit<span class="token punctuation">.</span><span class="token function">getCommitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>ModifyDt</span><span class="token punctuation">,</span> commit<span class="token punctuation">.</span><span class="token function">getCommitDt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Remark</span><span class="token punctuation">,</span> remark<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>permId<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-5-paginate-select" tabindex="-1"><a class="header-anchor" href="#_9d1-5-paginate-select" aria-hidden="true">#</a> 9D1.5.Paginate Select</h2><p>Use <code>PageJooqHelper</code> or <code>PageJdbcHelper</code> for paginating queries, Both are optimized for queries and can use the cached total number of records.</p><ul><li><code>total &lt; 0</code> - DB count and select</li><li><code>total = 0</code> - DB does not count, does not select</li><li><code>total &gt; 0</code> - DB does not count, but select</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">WinUserBasisTable</span> t1 <span class="token operator">=</span> winUserBasisDao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// dao dsl</span>
<span class="token class-name">PageJooqHelper</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>dao<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token class-name">WinUserBasisTable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// wrap query</span>
val qry4 <span class="token operator">=</span> dsl<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span><span class="token function">asterisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">PageJooqHelper</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>dao<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>qry4<span class="token punctuation">,</span> order<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token class-name">WinUserBasisTable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-6-logical-delete" tabindex="-1"><a class="header-anchor" href="#_9d1-6-logical-delete" aria-hidden="true">#</a> 9D1.6.Logical Delete</h2><p>Use <code>WingsJooqDaoJournal</code> for logical delete, but wings recommends physical deletion.</p><ul><li>dao.delete - by condition</li><li>dao.deleteById - by id</li></ul><p>Using <code>JournalJooqHelp</code> or <code>JournalJdbcHelp</code> can fire the jooq listener and trigger.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">JournalJooqHelp</span><span class="token punctuation">.</span><span class="token function">deleteByIds</span><span class="token punctuation">(</span>dsl<span class="token punctuation">,</span> <span class="token class-name">TstShardingTable<span class="token punctuation">.</span>TstSharding</span><span class="token punctuation">,</span> <span class="token number">12L</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">JournalJooqHelp</span><span class="token punctuation">.</span><span class="token function">deleteByIds</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">,</span> <span class="token string">&quot;\`tst_sharding\`&quot;</span><span class="token punctuation">,</span> <span class="token number">34L</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> <span class="token number">4L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// UPDATE \`tst_sharding\` SET commit_id=34, delete_dt=NOW(3)  WHERE id IN (3,4)</span>
<span class="token comment">// DELETE FROM \`tst_sharding\`  WHERE id IN (3,4)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-7-data-diff" tabindex="-1"><a class="header-anchor" href="#_9d1-7-data-diff" aria-hidden="true">#</a> 9D1.7.Data Diff</h2><p>Wings can use Trigger to track data changes, but its purpose is to allow fine-grained investigation or recovery of data during periods of business instability. Some business scenarios require external display of data change history, or even code diff-like display of data timelines.</p><p>In short, normal and stable business functions should not rely on Trigger and should have independent data structures. The following implementation, depending on the CUD, queries the database sequentially and compares the data differently in the default order.</p><ul><li>JournalDiff - data structure for one or more data diffs</li><li>dao.diffXXX - insert, update, delete data and get the differential data after insertion</li><li>JournalDiffHelper.helpXXX - help diff operation</li><li>JournalDiffHelper.diffXXX - direct diff database operations</li><li>JournalDiffHelper.tidyXXX - tidy up differential data</li><li>wings.faceless.jooq.cud.diff - default ignore for configuration tables</li></ul><p>The following is an updated example, for more examples see JooqDslAndDaoSample#test5Diff</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// use Dao</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> setter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginInfo</span><span class="token punctuation">,</span> <span class="token string">&quot;login by diff update&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">JournalDiff</span> d2 <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">diffUpdate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> setter<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// use Dsl</span>
val query <span class="token operator">=</span> dsl<span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">JournalDiff</span> d2 <span class="token operator">=</span> <span class="token class-name">JournalDiffHelper</span><span class="token punctuation">.</span><span class="token function">diffUpdate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> query<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    dsl<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginInfo</span><span class="token punctuation">,</span> <span class="token string">&quot;login by diff update&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>ModifyDt</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,34);function f(b,g){const a=e("ExternalLinkIcon");return o(),c("div",null,[i,k,n("ul",null,[n("li",null,[n("a",d,[s("JooqDslAndDaoSample.java"),t(a)])]),n("li",null,[n("a",r,[s("JooqMostSelectSample.java"),t(a)])]),n("li",null,[n("a",m,[s("JooqDeleteListenerTest"),t(a)])])]),v])}const y=p(u,[["render",f],["__file","9d1.jooq-funs.html.vue"]]);export{y as default};
