import{_ as l}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as c,c as p,b as e,e as n,d as a,w as t,f as i}from"./app-DeKKb_dP.js";const r={},d=i(`<h1 id="_9-practice-and-sample" tabindex="-1"><a class="header-anchor" href="#_9-practice-and-sample"><span>9.Practice and Sample</span></a></h1><p>Execute <code>wings-init-project.sh</code> to generate a template project.</p><h2 id="_9-1-pre-requisite" tabindex="-1"><a class="header-anchor" href="#_9-1-pre-requisite"><span>9.1.Pre-Requisite</span></a></h2><p>Basic knowledge and hands-on ability,</p><ul><li>Understand <code>maven</code>, what is missing, what to learn.</li><li>Understand <code>spring*</code>, <code>see official documentation</code> x 3!</li><li>Understand <code>mysql*</code> mysql database</li></ul><p>Directory conventions</p><ul><li><code>WINGS_DIR</code> - the project root of wings_boot</li><li><code>WINGS_BIN</code> - <code>WINGS_DIR</code>/observe/scripts</li><li><code>PROJECT_DIR</code> - the directory of the sample project, e.g. <code>good-demo</code></li><li><code>PROJECT_PCD</code> - CodeName of the sample project, e.g. <code>good</code></li></ul><h2 id="_9-2-diy-environment" tabindex="-1"><a class="header-anchor" href="#_9-2-diy-environment"><span>9.2.DIY Environment</span></a></h2><p>Sample scripts for new project and command to package,</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># asdf shell java temurin-17.0.9+9</span>
mvn <span class="token parameter variable">-v</span> <span class="token comment"># show version of maven and java</span>
<span class="token comment">#&gt; Apache Maven 3.8.7 (b89d5959fcde851dcb1c8946a785a163f14e1e29)</span>
<span class="token comment">#&gt; Java version: 17.0.9, vendor: Eclipse Adoptium</span>

<span class="token assign-left variable">WINGS_DIR</span><span class="token operator">=~</span>/Workspace/github.com/professional-wings
<span class="token assign-left variable">WINGS_BIN</span><span class="token operator">=</span><span class="token variable">$WINGS_BOOT</span>/observe/scripts
<span class="token assign-left variable">PROJECT_DIR</span><span class="token operator">=~</span>/Workspace/good-demo
<span class="token assign-left variable">PROJECT_PCD</span><span class="token operator">=</span>good

<span class="token comment"># create new project by template</span>
<span class="token variable">$WINGS_BIN</span>/wings-init-project.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Database, default H2, you can build Mysql Docker, the sample script as follows,</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># set env</span>
<span class="token assign-left variable">PASS</span><span class="token operator">=</span>S4f3_Password@MoilionCircle

<span class="token comment"># create a mysql docker</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">--name</span> good-mysql-8.0 <span class="token punctuation">\\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span>wings_example <span class="token punctuation">\\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token variable">\${PASS}</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\\</span>
mysql:8.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-3-app-deployment" tabindex="-1"><a class="header-anchor" href="#_9-3-app-deployment"><span>9.3.App Deployment</span></a></h2><p>Softlink(<code>ln -s</code>) wings-starter.sh to some execution location, using <code>good-devops</code> as an example.</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">$PROJECT_DIR</span>
<span class="token comment"># Create a boot script, one boot.jar corresponds to one pair of \`.sh\` and \`.env\`</span>
<span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token variable">$WINGS_BIN</span>/wings-starter.sh <span class="token variable">\${PROJECT_PCD}</span>-devops-starter.sh
<span class="token comment"># Copy the content of wings-starter.env and </span>
<span class="token comment"># save it with the same name as the boot script (different extname)</span>
<span class="token function">cp</span> <span class="token variable">$WINGS_BIN</span>/wings-starter.env <span class="token variable">\${PROJECT_PCD}</span>-devops-starter.env
<span class="token comment"># good is the default codename, if it has been changed, it must be modified,</span>
<span class="token comment"># otherwise the jar cannot be found</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;&#39;</span> <span class="token string">&quot;s:../../:./:&quot;</span> <span class="token variable">\${PROJECT_PCD}</span>-devops-starter.env
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;&#39;</span> <span class="token string">&quot;s:winx-:./<span class="token variable">\${PROJECT_PCD}</span>-:g&quot;</span> <span class="token variable">\${PROJECT_PCD}</span>-devops-starter.env
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In env, port,jar,log is easy to understand and can be configured according to project needs. BOOT_CNF is used to replace the default config at runtime, the structure is as follows.</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>├── application.properties // application level config
├── wings-conf // auto config, override on demand
│     └── spring-datasource.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-4-reverse-proxy" tabindex="-1"><a class="header-anchor" href="#_9-4-reverse-proxy"><span>9.4.Reverse Proxy</span></a></h2><p>The general config, including forced https, .git protection, and frontend and backend separation.</p><div class="language-nginx line-numbers-mode" data-ext="nginx" data-title="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> good_admin</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">ip_hash</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> good_appser_01:8090</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> good_appser_02:8090</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">300</span></span><span class="token punctuation">;</span> <span class="token comment"># long conn</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  admin.moilioncircle.com</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">access_log</span> /data/logs/nginx/admin.moilioncircle.com-access.log</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">error_log</span>  /data/logs/nginx/admin.moilioncircle.com-error.log</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span>     /data/nginx/cert/moilioncircle.com/fullchain.pem</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /data/nginx/cert/moilioncircle.com/privkey.pem</span><span class="token punctuation">;</span>

    <span class="token comment">#if ($scheme = http) {</span>
    <span class="token comment">#    return 301 https://$host$request_uri;</span>
    <span class="token comment">#}</span>
    
    <span class="token comment"># Defensive settings to protect .git</span>
    <span class="token directive"><span class="token keyword">location</span> .git</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">log_not_found</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># backend, resource url in res-id-{base64_urlsafe}.{pdf} format</span>
    <span class="token directive"><span class="token keyword">location</span> ~* (\\.json|/res-id-[\\-=_0-9a-z]+\\.[0-9a-z]+)$</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://good_admin</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span>  1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_bypass</span>  <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
    
        <span class="token directive"><span class="token keyword">proxy_set_header</span>  Connection   <span class="token string">&quot;&quot;</span></span><span class="token punctuation">;</span>            <span class="token comment"># long conn</span>
        <span class="token comment">#proxy_set_header Connection   &quot;upgrade&quot;;     # ws</span>
        <span class="token comment">#proxy_set_header Upgrade      $http_upgrade; # ws</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>  Host         <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>  X-Real-IP    <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span>    http://      <span class="token variable">$scheme</span>://</span><span class="token punctuation">;</span>    <span class="token comment"># https</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># frontend</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token comment">#add_header &#39;Access-Control-Allow-Origin&#39; &#39;*&#39;; #Allow CORS</span>
        <span class="token directive"><span class="token keyword">root</span> /data/static/good-admin-spa/</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_filename</span> ~* \\.(html|htm)$)</span><span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">add_header</span> Cache-Control no-cache,no-store,max-age=0,must-revalidate</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-5-stress-testing" tabindex="-1"><a class="header-anchor" href="#_9-5-stress-testing"><span>9.5.Stress Testing</span></a></h2><p>Stress test, must be <code>ulimit -n</code> above 10k, same intranet to ignore bandwidth limit.</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">$PROJECT_DIR</span>
<span class="token comment"># package and start</span>
mvn <span class="token parameter variable">-U</span> clean package
./<span class="token variable">\${PROJECT_PCD}</span>-devops-starter.sh start
<span class="token comment"># Ctrl-C to stop log output</span>
./<span class="token variable">\${PROJECT_PCD}</span>-devops-starter.sh stop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Using jmeter to simulate 10K*50 requests</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">45535</span>
<span class="token assign-left variable">JVM_ARGS</span><span class="token operator">=</span><span class="token string">&quot;-Xmx8G -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -XX:G1ReservePercent=20&quot;</span>

<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token variable">\${PROJECT_PCD}</span>-devops/target/load-test/ <span class="token operator">&amp;&amp;</span><span class="token punctuation">\\</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">\${PROJECT_PCD}</span>-devops/target/load-test/report

jmeter <span class="token parameter variable">-n</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">-t</span> <span class="token variable">\${PROJECT_PCD}</span>-devops/src/test/jmeter/load-test.jmx <span class="token punctuation">\\</span>
<span class="token parameter variable">-l</span> <span class="token variable">\${PROJECT_PCD}</span>-devops/target/load-test/load-test.jtl <span class="token punctuation">\\</span>
<span class="token parameter variable">-j</span> <span class="token variable">\${PROJECT_PCD}</span>-devops/target/load-test/load-test.log <span class="token punctuation">\\</span>
<span class="token parameter variable">-e</span> <span class="token parameter variable">-o</span> <span class="token variable">\${PROJECT_PCD}</span>-devops/target/load-test/report
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-6-security-option" tabindex="-1"><a class="header-anchor" href="#_9-6-security-option"><span>9.6.Security Option</span></a></h2><p>The default password in wings project is <code>\${random.uuid}</code> or environment variable. In actual production, some need to set to fixed password. Password strength, must be more than 32-bit random characters, alphanumeric case mix is best.</p>`,27),v=e("li",null,[e("code",null,"DING_TALK_TOKEN"),n(" - System variable, boot-admin login password")],-1),u=e("li",null,[e("code",null,"wings.silencer.encrypt.leap-code"),n(" - Pseudo-random number, can keep it")],-1),m=e("li",null,[e("code",null,"wings.silencer.encrypt.crc8-long"),n(" - Add crc checksum to number, can keep it")],-1),k=e("code",null,"wings.silencer.encrypt.aes-key.*",-1),b=e("code",null,"wings.slardar.hazelcast.cluster-name",-1),g=e("p",null,[n("In example project, use "),e("code",null,"DING_TALK_TOKEN"),n(" as default password")],-1),h=e("code",null,"spring.boot.admin.client.username",-1),_=e("code",null,"spring.boot.admin.client.password",-1),f=e("code",null,"spring.boot.admin.client.instance.metadata.user.name",-1),y=e("code",null,"spring.boot.admin.client.instance.metadata.user.password",-1),w=i(`<p>The default values for all of the above config items should be based on the corresponding manual or source code to avoid the security implications of outdated documentation.</p><h2 id="_9-7-start-up-args" tabindex="-1"><a class="header-anchor" href="#_9-7-start-up-args"><span>9.7.Start-up Args</span></a></h2><p>In springboot3(after java17), <code>add-opens</code> must be set correctly to avoid <code>illegal-access</code>. Wings set correctly in pom.xml and starter.sh, with the following files and variable names.</p><ul><li><code>/pom.xml</code> - <code>javaopenArgLine</code> with reason</li><li><code>/observe/scripts/wings-starter.sh</code> - <code>JDK9_ARG</code></li><li><code>&lt;arg&gt;</code> - must be specified with <code>=</code>, space is supported in shell</li></ul><p>The details of <code>add-opens</code> are as follows, handle line breaks when using</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>--add-modules=java.se
--add-exports=java.base/jdk.internal.ref=ALL-UNNAMED
--add-opens=java.base/java.io=ALL-UNNAMED
--add-opens=java.base/java.lang.invoke=ALL-UNNAMED
--add-opens=java.base/java.lang=ALL-UNNAMED
--add-opens=java.base/java.net=ALL-UNNAMED
--add-opens=java.base/java.nio=ALL-UNNAMED
--add-opens=java.base/java.util=ALL-UNNAMED
--add-opens=java.base/sun.nio.ch=ALL-UNNAMED
--add-opens=java.base/sun.security.x509=ALL-UNNAMED
--add-opens=java.management/sun.management=ALL-UNNAMED
--add-opens=jdk.management/com.sun.management.internal=ALL-UNNAMED
--add-opens=jdk.unsupported/sun.misc=ALL-UNNAMED
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6);function x(P,D){const s=o("Badge");return c(),p("div",null,[d,e("ul",null,[v,u,m,e("li",null,[k,n(" - "),a(s,{type:"tip",vertical:"top"},{default:t(()=>[n("SHOULD")]),_:1}),n(" change")]),e("li",null,[b,n(" - hazelcast clust name, "),a(s,{type:"info",vertical:"top"},{default:t(()=>[n("MUST")]),_:1}),n(" change")])]),g,e("ul",null,[e("li",null,[h,n(" - boot.admin server-side username, "),a(s,{type:"tip",vertical:"top"},{default:t(()=>[n("SHOULD")]),_:1}),n(" change")]),e("li",null,[_,n(" - boot.admin server-side password, "),a(s,{type:"info",vertical:"top"},{default:t(()=>[n("MUST")]),_:1}),n(" change")]),e("li",null,[f,n(" - client-side username, "),a(s,{type:"tip",vertical:"top"},{default:t(()=>[n("SHOULD")]),_:1}),n(" change")]),e("li",null,[y,n(" - client-side password, "),a(s,{type:"info",vertical:"top"},{default:t(()=>[n("MUST")]),_:1}),n(" change")])]),w])}const N=l(r,[["render",x],["__file","index.html.vue"]]),A=JSON.parse('{"path":"/9-example/","title":"9.Practice and Sample","lang":"en-US","frontmatter":{"isOriginal":true,"icon":"actions","category":["Practice","Home"],"description":"9.Practice and Sample Execute wings-init-project.sh to generate a template project. 9.1.Pre-Requisite Basic knowledge and hands-on ability, Understand maven, what is missing, wh...","GIT_REPO_HEAD":"2024-03-03 5d1e37643747355f7e7c87e8c0daf88979c5f90a","head":[["link",{"rel":"alternate","hreflang":"zh-cn","href":"https://wings.fessional.pro/zh/9-example/"}],["meta",{"property":"og:url","content":"https://wings.fessional.pro/9-example/"}],["meta",{"property":"og:site_name","content":"WingsBoot Win Sprint"}],["meta",{"property":"og:title","content":"9.Practice and Sample"}],["meta",{"property":"og:description","content":"9.Practice and Sample Execute wings-init-project.sh to generate a template project. 9.1.Pre-Requisite Basic knowledge and hands-on ability, Understand maven, what is missing, wh..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:locale:alternate","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-01-14T00:39:53.000Z"}],["meta",{"property":"article:author","content":"trydofor"}],["meta",{"property":"article:modified_time","content":"2024-01-14T00:39:53.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"9.Practice and Sample\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-01-14T00:39:53.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"trydofor\\",\\"url\\":\\"https://www.trydofor.com\\"}]}"]]},"headers":[{"level":2,"title":"9.1.Pre-Requisite","slug":"_9-1-pre-requisite","link":"#_9-1-pre-requisite","children":[]},{"level":2,"title":"9.2.DIY Environment","slug":"_9-2-diy-environment","link":"#_9-2-diy-environment","children":[]},{"level":2,"title":"9.3.App Deployment","slug":"_9-3-app-deployment","link":"#_9-3-app-deployment","children":[]},{"level":2,"title":"9.4.Reverse Proxy","slug":"_9-4-reverse-proxy","link":"#_9-4-reverse-proxy","children":[]},{"level":2,"title":"9.5.Stress Testing","slug":"_9-5-stress-testing","link":"#_9-5-stress-testing","children":[]},{"level":2,"title":"9.6.Security Option","slug":"_9-6-security-option","link":"#_9-6-security-option","children":[]},{"level":2,"title":"9.7.Start-up Args","slug":"_9-7-start-up-args","link":"#_9-7-start-up-args","children":[]}],"git":{"createdTime":1680228107000,"updatedTime":1705192793000,"contributors":[{"name":"trydofor","email":"trydofor@gmail.com","commits":6}]},"readingTime":{"minutes":2.77,"words":831},"filePathRelative":"9-example/README.md","localizedDate":"March 31, 2023","autoDesc":true}');export{N as comp,A as data};
