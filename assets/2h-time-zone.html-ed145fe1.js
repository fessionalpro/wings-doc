import{_ as t}from"./plugin-vue_export-helper-c27b6911.js";import{r as i,o as c,c as l,b as e,e as s,d as a,f as o}from"./app-7d38ae22.js";const p={},r=o(`<h1 id="_2h-时间和时区" tabindex="-1"><a class="header-anchor" href="#_2h-时间和时区" aria-hidden="true">#</a> 2H.时间和时区</h1><p>数据库有关的时间，时区，零值约定。</p><p>是<code>TimeZone</code>还是<code>timezone</code>，是大<code>Z</code>还是小<code>z</code>，这是一个问题 😃</p><p>首先，java中<code>TimeZone</code>和<code>ZoneId</code>都是中间大写的，两个词的。 但是，为了命名转换中不出现<code>time_zone</code>或<code>time-zone</code>， Wings在配置和数据层，全做一词处理，即<code>timezone</code>和<code>Zoneid</code>。</p><p>同样的处理方式，有时也出现在<code>DateTime</code>上。</p><h2 id="_2h-1-日时零值和时区" tabindex="-1"><a class="header-anchor" href="#_2h-1-日时零值和时区" aria-hidden="true">#</a> 2H.1.日时零值和时区</h2><p>执行环境和数据库要在同一时区，否则jooq和jdbc在以下过程会自动转换时区，引发问题。</p><p>如果服务器和执行环境时区不一致，可以通过以下方式协调。</p><ul><li>通过wings的参数设置时区 <code>wings.silencer.i18n.zoneid=Asia/Shanghai</code></li><li>java的启动参数 <code>-Duser.timezone=Asia/Shanghai</code></li><li>mysql的jdbc的url参数 <code>connectionTimeZone=%2B08:00&amp;forceConnectionTimeZoneToSession=true</code></li><li>java的代码参数 <code>TimeZone.setDefault(TimeZone.getTimeZone(&quot;Asia/Shanghai&quot;));</code></li></ul><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">wings.silencer.i18n.zoneid</span><span class="token punctuation">=</span><span class="token value attr-value">Asia/Shanghai</span>
<span class="token comment"># 常用jdbc参数</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/wings_example\\
  ?autoReconnect=true&amp;useSSL=false&amp;allowPublicKeyRetrieval=true\\
  &amp;useUnicode=true&amp;characterEncoding=UTF-8\\
  &amp;connectionTimeZone=Asia/Shanghai</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>引发问题的原因，目前断定为jdbc和timestamp历史问题（wings210后统一mysql8，已统一解决）</p><ul><li>jooq - 使用timestamp作为localDatetime的值，设置preparedStatement</li><li>jdbc - setTimestamp(int parameterIndex, Timestamp x), the JDBC driver uses the time zone of the virtual machine to calculate the date and time of the timestamp in that time zone.</li></ul><p>通过以下SQL可以在mysql端调查数据库执行过程</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看 系统，程序，会话时区</span>
<span class="token keyword">SELECT</span> @<span class="token variable">@system_time_zone</span><span class="token punctuation">,</span>  @<span class="token variable">@global.time_zone</span><span class="token punctuation">,</span> @<span class="token variable">@session.time_zone</span><span class="token punctuation">;</span>
<span class="token comment">-- @@system_time_zone, @@global.time_zone, @@session.time_zone</span>
<span class="token comment">-- UTC, Asia/Shanghai, Asia/Shanghai</span>

<span class="token comment">-- mysql 执行日志(UTC)</span>
<span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">\`</span>win_user<span class="token punctuation">\`</span></span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">\`</span>delete_dt<span class="token punctuation">\`</span></span> <span class="token operator">&lt;=</span> <span class="token string">&#39;0999-12-31 16:00:00.0&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- jooq 绑定日志(GMT+8)</span>
<span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">\`</span>win_user<span class="token punctuation">\`</span></span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">\`</span>delete_dt<span class="token punctuation">\`</span></span> <span class="token operator">&lt;=</span> <span class="token string">&#39;1000-01-01 00:00:00.0&#39;</span><span class="token punctuation">;</span>

<span class="token comment">-- 打开，日志，argument是blob类型</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> log_output <span class="token operator">=</span> <span class="token string">&#39;TABLE&#39;</span><span class="token punctuation">;</span><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> general_log <span class="token operator">=</span> <span class="token string">&#39;ON&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>general_log <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> event_time <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token comment">-- 关闭，清除</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> log_output <span class="token operator">=</span> <span class="token string">&#39;TABLE&#39;</span><span class="token punctuation">;</span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> general_log <span class="token operator">=</span> <span class="token string">&#39;OFF&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">truncate</span> <span class="token keyword">table</span> mysql<span class="token punctuation">.</span>general_log<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The session time zone setting affects display and storage of time values that are zone-sensitive. This includes the values displayed by functions such as NOW() or CURTIME(), and values stored in and retrieved from TIMESTAMP columns. Values for TIMESTAMP columns are converted from the session time zone to UTC for storage, and from UTC to the session time zone for retrieval.</p><p>在mysql中，尽量使用NOW(fsp)，因为其短小明确有缓存，如无必须不可使用SYSDATE(fsp)，参考</p>`,16),d={href:"https://dev.mysql.com/doc/refman/8.0/en/time-zone-support.html#time-zone-variables",target:"_blank",rel:"noopener noreferrer"},m={href:"https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_now",target:"_blank",rel:"noopener noreferrer"},u={href:"https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-configuration-properties.html",target:"_blank",rel:"noopener noreferrer"},k={href:"https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-datetime-types-processing.html",target:"_blank",rel:"noopener noreferrer"},h=o('<h2 id="_2h-2-数据库和jvm时区" tabindex="-1"><a class="header-anchor" href="#_2h-2-数据库和jvm时区" aria-hidden="true">#</a> 2H.2.数据库和Jvm时区</h2><p>常用的时区有2中格式，不管那种，都推荐使用稳定时区，如政策不会变，没有夏令时。</p><ul><li>容易理解的ZoneId形式 - 地理城市 <code>Asia/Shanghai</code>，<code>America/New_York</code></li><li>规则稳定的Offset形式 - 相对于UTC的时差，<code>UTC</code>，<code>+08:00</code></li></ul><p>wings中使用DatabaseChecker检查以下②③④时差是否一致，推荐全部一致。</p><ul><li>①system_time_zone - mysql host machine</li><li>②time_zone - mysql current time zone</li><li>③connectionTimeZone - jdbc connectionTimeZone/serverTimezone</li><li>④jvm TimeZone - jvm DefaultTimeZone</li><li>⑤host TimeZone - java host machine</li></ul><p>其中③是jdbc中特有的，和session timezone类似，但比<code>SET time_zone = timezone</code>强大。 若③④一致则不影响使用，但若非wings环境，在未设置③导致mysql默认使用②时，就会出现时差问题。</p><p>使用NOW()及TIMESTAMP类型时要注意时区，他们受③的影响。</p><blockquote><p>The session time zone setting affects display and storage of time values that are zone-sensitive. This includes the values displayed by functions such as NOW() or CURTIME(), and values stored in and retrieved from TIMESTAMP columns. Values for TIMESTAMP columns are converted from the session time zone to UTC for storage, and from UTC to the session time zone for retrieval.</p></blockquote><p>尽量使用 DATE, TIME, DATETIME类型，他们是时区无关的。</p><blockquote><p>The session time zone setting does not affect values displayed by functions such as UTC_TIMESTAMP() or values in DATE, TIME, or DATETIME columns. Nor are values in those data types stored in UTC; the time zone applies for them only when converting from TIMESTAMP values. If you want locale-specific arithmetic for DATE, TIME, or DATETIME values, convert them to UTC, perform the arithmetic, and then convert back.</p></blockquote><p>以上是数据库层面需要注意的地方，而以下为jdbc及java体系中的注意点，</p><ul><li>connectionTimeZone和forceConnectionTimeZoneToSession同时使用</li><li>connectionTimeZone的值，建议使用offset形式，<code>UTC</code>, <code>-40:00</code>, <code>+80:00</code></li><li>在jdbc url中，需要转义<code>+</code>，以<code>%2B08:00</code>表示<code>+80:00</code></li><li>业务侧建议使用ZoneId形式，mysql配置项，建议是有offset形式</li></ul><p>connectionTimeZone参数（8.0之前是serverTimezone）可以协调好jvm和mysql的时区， 单独使用connectionTimeZone，不会改变session级的time_zone， 需要配合forceConnectionTimeZoneToSession，才能达到session和jdbc一致的效果。</p><p>尽管以上设置可以满足项目要求，但因作用范围不如统一时区更稳定可靠，应该优先考虑统一时区。 此外在mysql配置中，建议使用offset格式时区，而业务侧使用ZoneId格式。</p><p>在配置JdbcUrl时，若使用<code>+</code>时（如下所示），会发生DateTimeException，因为在URL中<code>+</code>标识空格。 需要转义为<code>%2B</code>，即正确的格式为connectionTimeZone=%2B08:00</p><blockquote><p>wings?connectionTimeZone=+08:00 Invalid ID for region-based ZoneId, invalid format: 08:00</p></blockquote>',16);function v(f,T){const n=i("ExternalLinkIcon");return c(),l("div",null,[r,e("ul",null,[e("li",null,[e("a",d,[s("https://dev.mysql.com/doc/refman/8.0/en/time-zone-support.html#time-zone-variables"),a(n)])]),e("li",null,[e("a",m,[s("https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_now"),a(n)])]),e("li",null,[e("a",u,[s("https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-configuration-properties.html"),a(n)])]),e("li",null,[e("a",k,[s("https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-datetime-types-processing.html"),a(n)])])]),h])}const g=t(p,[["render",v],["__file","2h-time-zone.html.vue"]]);export{g as default};
