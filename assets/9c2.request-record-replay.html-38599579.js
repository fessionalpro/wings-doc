import{_ as r,X as t,Y as i,$ as n,a1 as s,a0 as a,a3 as o,C as l}from"./framework-e38ae8ee.js";const c={},p=n("h1",{id:"_9c2-记录和重放请求",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_9c2-记录和重放请求","aria-hidden":"true"},"#"),s(" 9C2.记录和重放请求")],-1),d=n("p",null,"在正式环境下，需求对某些http请求进行记录和重放。 简单易行的策略有，Nginx的mirror复制到GoReplay或wiremock。",-1),u=n("p",null,"参考资料如下，本手册以mirror微信请求到mocklab云服务和Gor本地服务为例",-1),k={href:"https://nginx.org/en/docs/http/ngx_http_mirror_module.html",target:"_blank",rel:"noopener noreferrer"},v={href:"https://wiremock.org/",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/buger/goreplay/wiki",target:"_blank",rel:"noopener noreferrer"},_=n("h2",{id:"_9c2-1-mocklab服务",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_9c2-1-mocklab服务","aria-hidden":"true"},"#"),s(" 9C2.1.mocklab服务")],-1),b=n("p",null,"使用github申请free账号，获得Mock APIs的URL和Token，如 Settings/Usage examples中的curl例子中有相应字段，如下特征，",-1),h={href:"https://xxxx.mocklab.io/",target:"_blank",rel:"noopener noreferrer"},g=n("li",null,"Token 14ef56fxxxx24fba5",-1),x=o(`<p>最后，可以在 Request Log 中获得所有请求，并Convert to stub以便测试使用。</p><h2 id="_9c2-2-gor本地服务" tabindex="-1"><a class="header-anchor" href="#_9c2-2-gor本地服务" aria-hidden="true">#</a> 9C2.2.gor本地服务</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> https://github.com/buger/goreplay/releases/download/1.3.3/gor_1.3.3_x64.tar.gz
<span class="token function">tar</span> <span class="token parameter variable">-xzf</span> gor_1.3.3_x64.tar.gz
<span class="token comment"># 开启并监听 18081，若是attach到其他服务端口，则不需要http-pprof</span>
<span class="token function">tee</span> gor.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
gor_file=weixin-%Y%m%d.gor
cur_file=$(date +$gor_file)
test -f &quot;$cur_file&quot; &amp;&amp; mv $cur_file $cur_file.$(date +%H%M%S)
./gor --http-pprof :18081 \\
--input-raw :18081 \\
--output-file $gor_file \\
--output-file-append
EOF</span>
<span class="token function">chmod</span> +x gor.sh
<span class="token function">sudo</span> <span class="token function">nohup</span> ./gor.sh <span class="token operator">&amp;</span>
<span class="token comment"># test</span>
<span class="token function">curl</span> http://127.0.0.1:18081/debug/pprof/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),f={href:"https://github.com/buger/goreplay/blob/master/output_file.go",target:"_blank",rel:"noopener noreferrer"},y=o(`<ul><li>output-file-append无效，重启gor时会覆盖gor文件，需要注意备份</li><li>output-file 不会自动flush，只能buff满或关闭gor</li><li>若需要实时观测，建议使用 output-stdout</li></ul><h2 id="_9c2-3-nginx的mirror" tabindex="-1"><a class="header-anchor" href="#_9c2-3-nginx的mirror" aria-hidden="true">#</a> 9C2.3.nginx的mirror</h2><blockquote><p>The ngx_http_mirror_module module (1.13.4) implements mirroring of an original request by creating background mirror subrequests. Responses to mirror subrequests are ignored.</p></blockquote><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /weixin/geteway.api</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">mirror</span> /__mirror_mock</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">mirror</span> /__mirror_gor</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://xxxx</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> = /__mirror_mock</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">resolver</span> 8.8.8.8</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> https://xxx.mocklab.io<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Authorization <span class="token string">&quot;Token 14exxxxxxxba5&quot;</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> = /__mirror_gor</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:18081<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9c2-4-使用建议" tabindex="-1"><a class="header-anchor" href="#_9c2-4-使用建议" aria-hidden="true">#</a> 9C2.4.使用建议</h2><p>gor和mocklab设置其一即可，根据情况取舍，dev环境建议mocklab，便于生成test。</p>`,6),w=n("code",null,"resolver 8.8.8.8",-1),q={href:"http://xxx.mocklab.io",target:"_blank",rel:"noopener noreferrer"};function $(R,C){const e=l("ExternalLinkIcon");return t(),i("div",null,[p,d,u,n("ul",null,[n("li",null,[n("a",k,[s("Nginx/mirror"),a(e)])]),n("li",null,[n("a",v,[s("wiremock/mocklab"),a(e)])]),n("li",null,[n("a",m,[s("GoReplay/Gor"),a(e)])])]),_,b,n("ul",null,[n("li",null,[n("a",h,[s("https://xxxx.mocklab.io/"),a(e)])]),g]),x,n("p",null,[s("注意，gor 2.0目前还在rc阶段，1.3实测中存在一些问题，比如保存文件时 "),n("a",f,[s("https://github.com/buger/goreplay/blob/master/output_file.go"),a(e)])]),y,n("p",null,[s("若mirror没有转发，可观测nginx error日志，上例中的"),w,s("解决一下问题， no resolver defined to resolve "),n("a",q,[s("xxx.mocklab.io"),a(e)]),s(', request: "POST ..."')])])}const T=r(c,[["render",$],["__file","9c2.request-record-replay.html.vue"]]);export{T as default};
