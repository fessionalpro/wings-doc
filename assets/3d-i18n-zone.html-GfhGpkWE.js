import{_ as s}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as t,o,c as i,b as c,e as n,d as l,w as p,f as e}from"./app-GuRyqIDd.js";const r={},u=e(`<h1 id="_3d-multiple-time-and-lang" tabindex="-1"><a class="header-anchor" href="#_3d-multiple-time-and-lang" aria-hidden="true">#</a> 3D.Multiple Time and Lang</h1><p>In Silencer configuration, all I18n messages located in <code>wigns-i18n/</code> are automatically loaded.</p><h2 id="_3d-1-loading-order" tabindex="-1"><a class="header-anchor" href="#_3d-1-loading-order" aria-hidden="true">#</a> 3D.1.Loading Order</h2><p>With <code>LocaleResolver</code>, the current locale are set in the following order of priority.</p><ol><li>the <code>WINGS.I18N_CONTEXT</code> attr in the request</li><li>query string <code>locale</code>, <code>zoneid</code></li><li>http header <code>Accept-Language</code>, <code>Zone-Id</code></li><li>cookie <code>Wings-Locale</code>, <code>Wings-Zoneid</code></li><li>login user&#39;s SecurityContext to get Wings settings</li><li>system default value</li></ol><p>Note: <code>zoneid</code> is a word in DB and config, while <code>ZoneId</code> is a class (I capitalized) in java. So, when selecting from Db and geting it by reflection, it is easy to miss the assignment of ZoneId due to case sensitive.</p><p>The <code>LocaleResolver</code> acts in the <code>doService</code>, after the <code>doFilter</code>, so there is no Context in the <code>Filter</code>.</p><h2 id="_3d-2-locale-resolver" tabindex="-1"><a class="header-anchor" href="#_3d-2-locale-resolver" aria-hidden="true">#</a> 3D.2.Locale Resolver</h2><p><code>WingsLocaleResolver</code> is a servlet implementation and does not support webflux.</p><ul><li>After user login, Locale and ZoneId is automatically generated in the Context</li><li><code>SecurityContextUtil</code> gets the Context in the Mvc layer, implemented by Filter</li><li><code>WingsTerminalContext</code> is used in the Service layer, implemented by TerminalInterceptor</li></ul><p>For multiple timezones, the Enum is used to automatically generate the standard timezones to parse and use. In terms of encoding naming, the type relationships and naming conventions are as follows.</p><ul><li>language - corresponds to StandardLanguageEnum</li><li>timezone - corresponds to StandardTimezoneEnum</li><li>locale - corresponds to java.util.</li><li>zoneid - corresponds to java.time.</li></ul><p>In js environment, use <code>Intl.DateTimeFormat().resolvedOptions().timeZone</code> to get the timezone. If the client cannot get the zoneid, it can get the zone info from server, use its offset, country to determine by itself.</p><h2 id="_3d-3-i18n-placeholder" tabindex="-1"><a class="header-anchor" href="#_3d-3-i18n-placeholder" aria-hidden="true">#</a> 3D.3.I18n Placeholder</h2><p><code>@Valid</code> of JavaBean Validation supports the Unified Expression Language (JSR 341). Use <code>\${}</code> to access external variables and <code>{}</code> to access variables within annotation, as in the following example</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Size</span><span class="token punctuation">(</span> min <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;{common.email.size}&quot;</span><span class="token punctuation">)</span>
# <span class="token class-name">Set</span> in the i18n message
common<span class="token punctuation">.</span>email<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token class-name">The</span> author email &#39;$<span class="token punctuation">{</span>validatedValue<span class="token punctuation">}</span>&#39; must be between <span class="token punctuation">{</span>min<span class="token punctuation">}</span> and <span class="token punctuation">{</span>max<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And in <code>Message&#39;s ResourceBundle</code>, it use the array <code>{0}</code> format of java.text by default.</p><h2 id="_3d-4-i18n-practice" tabindex="-1"><a class="header-anchor" href="#_3d-4-i18n-practice" aria-hidden="true">#</a> 3D.4.I18n Practice</h2><p>For I18n supported project , in addition to defining Code for static Message, the greater workload is handling dynamic business messages. The more common ones are such as input parameter checking, execution state checking, output result confirmation, etc.</p><h3 id="pre-condition-check" tabindex="-1"><a class="header-anchor" href="#pre-condition-check" aria-hidden="true">#</a> Pre-condition check</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// throw stackless CodeException</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test/code-exception.json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">codeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AssertArgs</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">CommonErrorEnum<span class="token punctuation">.</span>AssertEmpty1</span><span class="token punctuation">,</span> <span class="token string">&quot;args&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CodeException</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">CommonErrorEnum<span class="token punctuation">.</span>AssertEmpty1</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// use Validation annotation</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Ins</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;{test.name.empty}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Email</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;{test.email.invalid}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test/binding-error-from.json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">bindingErrorFrom</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">Ins</span> ins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">okData</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="r-w-group-verification" tabindex="-1"><a class="header-anchor" href="#r-w-group-verification" aria-hidden="true">#</a> R/W Group Verification</h3><p>In Mvc practice, the recommended pattern is to use groups to distinguish between insert and update validation</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// FormData, containing all fields, more concise, but note the use of</span>
<span class="token comment">// Inherited pattern OutSkuUpd extends OutSkuAdd, verbose but typesafe</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OutSkuForm</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;{form.validate.updateoutsku.id}&quot;</span><span class="token punctuation">,</span> groups <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">Update</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;Spec id, required for updates&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Controller use @Validated group</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;modify Spec&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wh/outsku/update-outsku.json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">updateOutSku</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token annotation punctuation">@Validated</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">Update</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token class-name">OutSkuForm</span> ins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="execution-state-check" tabindex="-1"><a class="header-anchor" href="#execution-state-check" aria-hidden="true">#</a> Execution State Check</h3><p>Predefined CodeEnum, associated Message resource, output I18n message via global exception handling</p><ul><li><code>AssertState</code> - like AssertArgs, throws stackless exceptions</li><li><code>MessageException</code> - throws a stackless exception with code</li><li><code>CodeException</code> - by default throws a stacked exception</li><li><code>I18nString</code> - automatically convert to String output via json</li><li><code>@JsonI18nString</code> - annotate the field for automatic json conversion</li></ul><h3 id="i18n-message-resources" tabindex="-1"><a class="header-anchor" href="#i18n-message-resources" aria-hidden="true">#</a> I18n message resources</h3>`,28),d=e('<h2 id="_3d-5-three-kinds-of-datetime" tabindex="-1"><a class="header-anchor" href="#_3d-5-three-kinds-of-datetime" aria-hidden="true">#</a> 3D.5.Three Kinds of DateTime</h2><p>Multiple timezones, for data readability and coding convenience, slardar use the following conventions.</p><ul><li><code>system timezone</code> (system) - application/system run, unified on Jvm and Db</li><li><code>data timezone</code> (origin) - the data or users are located</li><li><code>user timezone</code> (client) - the user wants to see when reading the data</li></ul><p>In general, these three are unified, e.g. all in Beijing time <code>GMT+8</code>. For data that is not timezone sensitive, LocalDateTime is usually a good choice, without the timezone.</p><p>In the slardar business scenarios, the system timezone is used uniformly in the business layer, using LocalDateTime. And in the Controller layer, it is responsible for the two-way conversion of system and user timezones, using ZonedDateTime.</p><ul><li>Uniformly use <code>LocalDateTime</code> for timezone insensitive or localtime only cases</li><li>Automatic conversion in Jackson and RequestParam if timezone is sensitive <ul><li>When Request, auto converts user time to the system timezone</li><li>When Response, auto converts system time to the user timezone</li></ul></li><li>The following three types of auto-conversion are available, <ul><li><code>LocalDateTime</code> disabled by default, not recommended to convert</li><li><code>ZonedDatetime</code> disabled by default, historical compatibility</li><li><code>OffsetDateTime</code> enabled by default</li></ul></li><li>Use the <code>@AutoTimeZone</code> to specify the conversion behavior of the 3 types of dates <ul><li>Use on Dto&#39;s Field to auto convert in RequestBody and ResponseBody</li><li>Work with Spring&#39;s @RequestParam for Param</li></ul></li><li>Use AutoDtoHelper to replace Dto properties outside of Spring administration, currently the following annotations are supported <ul><li>@AutoDtoAble - traverses internal properties</li><li>@AutoTimeZone - auto convert 3 types of dates</li><li>@AutoI18nString - auto convert String or I18nString</li></ul></li></ul><p>Note: due to a defect in util.Date, in wings, you have to use the <code>java.time.*</code> instead .</p><p>For example, the 3 timezones are not the same, for more testcases see <code>DateTimeConverterTest.java</code></p><p>Example A: An online classroom application, Chinese student and NewYork teacher, schedule a class time. then.</p><ul><li>Assume that the system is on UTC time, i.e. system=<code>UTC+0</code></li><li>the student and teacher client are <code>Asia/Shanghai</code> and <code>America/New_York</code> respectively</li><li>When making an appointment, you need to display the time by client separately to improve the appointment experience</li></ul><p>Example B: A cross-border e-commerce application, NewYork users, via overseas shipping warehouse, buy things in xxBao. then.</p><ul><li>Assume that xxBao is on East 8, i.e. system=<code>UTC+8</code></li><li>NY user&#39;s (client) is <code>America/New_York</code></li><li>LA shipping warehouse, i.e. (origin) is <code>America/Los_Angeles</code></li><li>Order information, which will be displayed in client time</li><li>Logistics information displayed in local time(origin) without conversion</li><li>Statistical information, usually also displayed in data/origin time</li></ul>',12);function m(k,h){const a=t("RouterLink");return o(),i("div",null,[u,c("p",null,[n("See "),l(a,{to:"/0-wings/0i-i18n-message.html"},{default:p(()=>[n("I18n Message")]),_:1})]),d])}const b=s(r,[["render",m],["__file","3d-i18n-zone.html.vue"]]);export{b as default};
