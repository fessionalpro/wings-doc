import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o,c,b as n,e as s,d as t,f as l}from"./app-b67efd75.js";const u={},i=n("h1",{id:"_9d1-jooq-better-practive",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_9d1-jooq-better-practive","aria-hidden":"true"},"#"),s(" 9D1.Jooq Better Practive")],-1),k=n("p",null,"WingsBoot体系内对Jooq进行了简化，在实践中有以下约定和语法糖",-1),d={href:"https://github.com/trydofor/pro.fessional.wings/blob/master/wings/faceless-jooq/src/test/java/pro/fessional/wings/faceless/sample/JooqDslAndDaoSample.java",target:"_blank",rel:"noopener noreferrer"},r={href:"https://github.com/trydofor/pro.fessional.wings/blob/master/wings/faceless-jooq/src/test/java/pro/fessional/wings/faceless/sample/JooqMostSelectSample.java",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/trydofor/pro.fessional.wings/blob/master/wings/faceless-jooq/src/test/java/pro/fessional/wings/faceless/jooq/JooqDeleteListenerTest.java",target:"_blank",rel:"noopener noreferrer"},v=l(`<h2 id="_9d1-1-代码生成" tabindex="-1"><a class="header-anchor" href="#_9d1-1-代码生成" aria-hidden="true">#</a> 9D1.1.代码生成</h2><p>推荐使用<code>Warlock3JooqGenerator</code>，其进一步封装了<code>WingsCodeGenerator</code>，</p><ul><li>databaseIncludes - 基于正则，指定生成代码的表</li><li>setGlobalSuffix - 可对全局对象增加后缀，以区分同包不同工程</li><li>forcedStrCodeEnum - 绑定varchar和enum类型</li><li>forcedIntConsEnum - 绑定int和emum类型</li><li>forcedLocale - 绑定varchar和Locale类型</li><li>forcedZoneId - 绑定int和ZoneId类型</li><li>forcedZoneStr - 绑定varchar和ZoneId类型</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Warlock3JooqGenerator</span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Warlock3JooqGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
generator<span class="token punctuation">.</span><span class="token function">setTargetDir</span><span class="token punctuation">(</span><span class="token constant">JAVA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
generator<span class="token punctuation">.</span><span class="token function">gen</span><span class="token punctuation">(</span><span class="token constant">JDBC</span><span class="token punctuation">,</span> <span class="token constant">USER</span><span class="token punctuation">,</span> <span class="token constant">PASS</span><span class="token punctuation">,</span>
        <span class="token class-name">Warlock3JooqGenerator</span><span class="token punctuation">.</span><span class="token function">includeWarlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bd <span class="token operator">-&gt;</span> bd<span class="token punctuation">.</span><span class="token function">setGlobalSuffix</span><span class="token punctuation">(</span><span class="token string">&quot;Warlock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认配置中，对以下类型做了映射</p><ul><li>Boolean - <code>TINYINT(\\(1\\))?</code>，所有字段</li><li>Integer - <code>TINYINT[2-9()]*</code>，所有字段</li><li>Locale - 字段<code>.*\\.locale</code>，所有类型</li><li>ZoneId - 字段<code>*\\.zoneid</code>，类型<code>INT.*</code>和<code>(VAR)?CHAR.*</code></li></ul><h2 id="_9d1-2-dao和dsl" tabindex="-1"><a class="header-anchor" href="#_9d1-2-dao和dsl" aria-hidden="true">#</a> 9D1.2.Dao和Dsl</h2><p>Jooq官方示例中，都采用了静态引入Table，注入Dsl的形式，但在wings中推荐从Dao入手。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 以lombok完成Setter注入，必须setter注入</span>
<span class="token annotation punctuation">@Setter</span><span class="token punctuation">(</span>onMethod_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Autowired</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">WinConfRuntimeDao</span> dao<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 检查表是否存在</span>
dao<span class="token punctuation">.</span><span class="token function">notTableExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 通过Dao获取Table和Dsl</span>
<span class="token class-name">WinConfRuntimeTable</span> a <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WinConfRuntimeTable</span> t <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DSLContext</span> dsl <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>WingsJooqDaoAliasImpl和WingsJooqDaoJournalImpl中存在大量方法</p><ul><li>batchXX - 批量插入，合并，更新等操作有关</li><li>fetchXX - 按类型或自动读取数据</li><li>countXX - count记录数</li><li>insertXX - 插入有关</li><li>updateXX - 更新有关</li><li>deleteXX - 逻辑或物理删除</li></ul><p>Dsl和Dao等价，都在service层以下使用。</p><ul><li>简单操作用Dao，复杂的用Dsl</li><li>Dao更像java，Dsl更像Sql</li><li>当有条件和字段时，两者都要明确table或alias</li><li>Dsl可以getSql，也可用Any2Dto把Sql变为Dsl</li></ul><h2 id="_9d1-3-精确查找" tabindex="-1"><a class="header-anchor" href="#_9d1-3-精确查找" aria-hidden="true">#</a> 9D1.3.精确查找</h2><p>用什么就获取什么，用pojo或record接收，确保强类型。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">WinUserLoginTable</span> t <span class="token operator">=</span> winUserLoginDao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao </span>
dao<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span>
    <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao lambda</span>
dao<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> w
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dsl</span>
winUserLoginDao
    <span class="token punctuation">.</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>AuthType</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginIp</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginDt</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Terminal</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Failed</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginDt</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">toOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> query<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-4-精确更新" tabindex="-1"><a class="header-anchor" href="#_9d1-4-精确更新" aria-hidden="true">#</a> 9D1.4.精确更新</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">WinUserBasisTable</span> tu <span class="token operator">=</span> winUserBasisDao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao map</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> setter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Nickname</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> commit<span class="token punctuation">.</span><span class="token function">getCommitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
winUserBasisDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tu<span class="token punctuation">,</span> setter<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Dao pojo</span>
<span class="token class-name">WinUserBasisTable</span> upo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WinUserBasisTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
upo<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
upo<span class="token punctuation">.</span><span class="token function">setCommitId</span><span class="token punctuation">(</span>commit<span class="token punctuation">.</span><span class="token function">getCommitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
winUserBasisDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tu<span class="token punctuation">,</span> upo<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Dsl</span>
winPermEntryDao
    <span class="token punctuation">.</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tu<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> commit<span class="token punctuation">.</span><span class="token function">getCommitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>ModifyDt</span><span class="token punctuation">,</span> commit<span class="token punctuation">.</span><span class="token function">getCommitDt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Remark</span><span class="token punctuation">,</span> remark<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">tu<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>permId<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-5-分页查询" tabindex="-1"><a class="header-anchor" href="#_9d1-5-分页查询" aria-hidden="true">#</a> 9D1.5.分页查询</h2><p>分页查询使用<code>PageJooqHelper</code>或<code>PageJdbcHelper</code>， 两者都进行了查询优化，可使用缓存的总记录数total。</p><ul><li><code>total &lt; 0</code> - DB执行count和select</li><li><code>total = 0</code> - DB不count，不select</li><li><code>total &gt; 0</code> - DB不count，但select</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">WinUserBasisTable</span> t1 <span class="token operator">=</span> winUserBasisDao<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// dao dsl</span>
<span class="token class-name">PageJooqHelper</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>dao<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token class-name">WinUserBasisTable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// wrap query</span>
val qry4 <span class="token operator">=</span> dsl<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span><span class="token function">asterisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t1<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">PageJooqHelper</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>dao<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>qry4<span class="token punctuation">,</span> order<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token class-name">WinUserBasisTable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-6-逻辑删除" tabindex="-1"><a class="header-anchor" href="#_9d1-6-逻辑删除" aria-hidden="true">#</a> 9D1.6.逻辑删除</h2><p>逻辑删除使用<code>WingsJooqDaoJournal</code>即可，不过wings推荐物理删除。</p><ul><li>dao.delete - by condition</li><li>dao.deleteById - by id</li></ul><p>使用<code>JournalJooqHelp</code>或<code>JournalJdbcHelp</code>，可以触发jooq监听和trigger。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">JournalJooqHelp</span><span class="token punctuation">.</span><span class="token function">deleteByIds</span><span class="token punctuation">(</span>dsl<span class="token punctuation">,</span> <span class="token class-name">TstShardingTable<span class="token punctuation">.</span>TstSharding</span><span class="token punctuation">,</span> <span class="token number">12L</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">JournalJooqHelp</span><span class="token punctuation">.</span><span class="token function">deleteByIds</span><span class="token punctuation">(</span>tmpl<span class="token punctuation">,</span> <span class="token string">&quot;\`tst_sharding\`&quot;</span><span class="token punctuation">,</span> <span class="token number">34L</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">,</span> <span class="token number">4L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// UPDATE \`tst_sharding\` SET commit_id=34, delete_dt=NOW(3)  WHERE id IN (3,4)</span>
<span class="token comment">// DELETE FROM \`tst_sharding\`  WHERE id IN (3,4)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9d1-7-数据差分" tabindex="-1"><a class="header-anchor" href="#_9d1-7-数据差分" aria-hidden="true">#</a> 9D1.7.数据差分</h2><p>Wings可用Trigger跟踪数据变化，但其目的是在业务不稳定期，可细粒度的调查或恢复数据。 有些业务场景需要对外展示数据变化历史，甚至类似代码diff一样，显示数据时间线。</p><p>一句话，正常的稳定的业务功能，不应该依赖Trigger，应该有独立的数据结构。 以下实现，根据CUD的不同，先后查询数据库，按默认顺序对数据进行差分比较。</p><ul><li>JournalDiff - 一条或多条数据差分的数据结构</li><li>dao.diffXXX - 插入，更新，删除数据，获得插入后的差分数据</li><li>JournalDiffHelper.helpXXX - 辅助差分操作</li><li>JournalDiffHelper.diffXXX - 直接差分数据库操作</li><li>JournalDiffHelper.tidyXXX - 简化差分数据</li><li>wings.faceless.jooq.cud.diff - 配置表的默认忽略项</li></ul><p>以下为更新示例，更多示例参考 JooqDslAndDaoSample#test5Diff</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 使用Dao</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> setter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
setter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginInfo</span><span class="token punctuation">,</span> <span class="token string">&quot;login by diff update&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">JournalDiff</span> d2 <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">diffUpdate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> setter<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用Dsl</span>
val query <span class="token operator">=</span> dsl<span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">JournalDiff</span> d2 <span class="token operator">=</span> <span class="token class-name">JournalDiffHelper</span><span class="token punctuation">.</span><span class="token function">diffUpdate</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> query<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    dsl<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>CommitId</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>LoginInfo</span><span class="token punctuation">,</span> <span class="token string">&quot;login by diff update&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>ModifyDt</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,34);function f(b,g){const a=e("ExternalLinkIcon");return o(),c("div",null,[i,k,n("ul",null,[n("li",null,[n("a",d,[s("JooqDslAndDaoSample.java"),t(a)])]),n("li",null,[n("a",r,[s("JooqMostSelectSample.java"),t(a)])]),n("li",null,[n("a",m,[s("JooqDeleteListenerTest"),t(a)])])]),v])}const I=p(u,[["render",f],["__file","9d1.jooq-funs.html.vue"]]);export{I as default};
